<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - YourMove</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: #e0e0ff;
        }
        
        /* Neon Gradient Colors */
        :root {
            --cyan: #00f5ff;
            --purple: #8b5cf6;
            --pink: #ff006e;
            --dark-bg: #0a0a0f;
            --card-bg: #141420;
        }
        
        .gradient-text {
            background: linear-gradient(90deg, var(--cyan), var(--purple), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .navbar {
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        /* Status Colors */
        .status-normal { fill: #00f5ff; }
        .status-elevated { fill: #fbbf24; }
        .status-warning { fill: #f97316; }
        .status-critical { fill: #ff006e; }
        
        /* Connection Indicator */
        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .connection-active {
            background: var(--cyan);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        .connection-inactive {
            background: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Tab Styles */
        .tab-btn {
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tab-active {
            border-bottom-color: var(--cyan);
            color: var(--cyan);
        }
        
        /* Button Styles */
        .btn-gradient {
            background: linear-gradient(135deg, var(--cyan), var(--purple), var(--pink));
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 245, 255, 0.4);
        }
        
        /* Body Part Hover */
        .body-part {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .body-part:hover {
            opacity: 0.7;
            filter: brightness(1.2);
        }
        
        /* Hidden Class */
        .hidden {
            display: none !important;
        }
        
        /* Modal Styles */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        /* Chart Container - FIXED SIZE to prevent zoom */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Severity Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-critical {
            background: rgba(255, 0, 110, 0.2);
            color: var(--pink);
        }
        
        .badge-high {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
        }
        
        .badge-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .badge-low {
            background: rgba(0, 245, 255, 0.2);
            color: var(--cyan);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar sticky top-0 z-50">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none">
                        <defs>
                            <linearGradient id="navGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00f5ff;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#ff006e;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="45" stroke="url(#navGradient)" stroke-width="4" fill="none"/>
                    </svg>
                    <span class="text-xl font-bold gradient-text">YourMove</span>
                    <span class="text-sm text-gray-500 hidden md:inline">Doctor Dashboard</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="doctorName" class="text-sm text-gray-400"></span>
                    <button onclick="logout()" class="text-pink-500 hover:text-pink-400 text-sm font-medium transition">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Tabs -->
        <div class="mb-6">
            <div class="border-b border-gray-800">
                <nav class="flex space-x-8">
                    <button onclick="showTab('monitor')" id="tab-monitor" class="tab-btn tab-active text-gray-400">
                        Live Session Monitor
                    </button>
                    <button onclick="showTab('patients')" id="tab-patients" class="tab-btn text-gray-500">
                        Patient Management
                    </button>
                </nav>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div id="content-monitor" class="tab-content">
            <!-- Connection Status -->
            <div class="card mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="connectionIndicator" class="connection-dot connection-inactive"></div>
                        <div>
                            <h3 class="text-lg font-semibold">Session Status</h3>
                            <p id="connectionStatus" class="text-sm text-gray-500">Waiting for connection...</p>
                        </div>
                    </div>
                    <div id="sessionInfo" class="text-right text-sm text-gray-500"></div>
                </div>
            </div>

            <!-- Main Monitoring Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Body Diagram -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4 gradient-text">Body Stress Map</h3>
                    <div class="flex justify-center">
                        <svg width="280" height="480" viewBox="0 0 280 480">
                            <!-- Head -->
                            <circle class="body-part status-normal" id="part-head" cx="140" cy="40" r="25" />
                            <text x="140" y="45" text-anchor="middle" fill="white" font-size="9" font-weight="bold">Head</text>
                            
                            <!-- Chest -->
                            <rect class="body-part status-normal" id="part-chest" x="115" y="75" width="50" height="70" rx="8" />
                            <text x="140" y="115" text-anchor="middle" fill="white" font-size="9" font-weight="bold">Chest</text>
                            
                            <!-- Hip -->
                            <rect class="body-part status-normal" id="part-hip" x="120" y="155" width="40" height="35" rx="5" />
                            <text x="140" y="177" text-anchor="middle" fill="white" font-size="9" font-weight="bold">Hip</text>
                            
                            <!-- Left Upper Arm -->
                            <rect class="body-part status-normal" id="part-left_upper_arm" x="70" y="85" width="35" height="60" rx="17" />
                            <text x="87" y="118" text-anchor="middle" fill="white" font-size="8">L Arm</text>
                            
                            <!-- Right Upper Arm -->
                            <rect class="body-part status-normal" id="part-right_upper_arm" x="175" y="85" width="35" height="60" rx="17" />
                            <text x="192" y="118" text-anchor="middle" fill="white" font-size="8">R Arm</text>
                            
                            <!-- Left Lower Arm -->
                            <rect class="body-part status-normal" id="part-left_lower_arm" x="65" y="150" width="30" height="70" rx="15" />
                            <text x="80" y="188" text-anchor="middle" fill="white" font-size="7">L Hand</text>
                            
                            <!-- Right Lower Arm -->
                            <rect class="body-part status-normal" id="part-right_lower_arm" x="185" y="150" width="30" height="70" rx="15" />
                            <text x="200" y="188" text-anchor="middle" fill="white" font-size="7">R Hand</text>
                            
                            <!-- Left Hand -->
                            <circle class="body-part status-normal" id="part-left_hand" cx="80" cy="230" r="12" />
                            
                            <!-- Right Hand -->
                            <circle class="body-part status-normal" id="part-right_hand" cx="200" cy="230" r="12" />
                            
                            <!-- Left Upper Leg -->
                            <rect class="body-part status-normal" id="part-left_upper_leg" x="110" y="195" width="25" height="95" rx="12" />
                            <text x="122" y="245" text-anchor="middle" fill="white" font-size="7">L Leg</text>
                            
                            <!-- Right Upper Leg -->
                            <rect class="body-part status-normal" id="part-right_upper_leg" x="145" y="195" width="25" height="95" rx="12" />
                            <text x="157" y="245" text-anchor="middle" fill="white" font-size="7">R Leg</text>
                            
                            <!-- Left Lower Leg -->
                            <rect class="body-part status-normal" id="part-left_lower_leg" x="108" y="295" width="28" height="90" rx="14" />
                            
                            <!-- Right Lower Leg -->
                            <rect class="body-part status-normal" id="part-right_lower_leg" x="144" y="295" width="28" height="90" rx="14" />
                        </svg>
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded status-normal"></div>
                            <span>Normal</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded status-elevated"></div>
                            <span>Elevated</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded status-warning"></div>
                            <span>Warning</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded status-critical"></div>
                            <span>Critical</span>
                        </div>
                    </div>
                </div>

                <!-- Metrics and AI -->
                <div class="space-y-6">
                    <!-- Global Metrics -->
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 gradient-text">Global Metrics</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-500">Focus Level</div>
                                <div id="focusLevel" class="text-2xl font-bold text-cyan-400">--</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Max Stress</div>
                                <div id="maxStress" class="text-2xl font-bold text-pink-400">--</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Max Tremor</div>
                                <div id="maxTremor" class="text-2xl font-bold text-purple-400">--</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Avg Stress</div>
                                <div id="avgStress" class="text-2xl font-bold text-cyan-400">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 gradient-text">AI Recommendations</h3>
                        <div id="aiRecommendations">
                            <p class="text-gray-500 text-sm">Waiting for data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Focus Level Over Time</h3>
                    <div class="chart-container">
                        <canvas id="focusChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Stress Level Over Time</h3>
                    <div class="chart-container">
                        <canvas id="stressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patients Tab -->
        <div id="content-patients" class="tab-content hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold gradient-text">Patient Management</h3>
                    <button onclick="showAddPatientModal()" class="btn-gradient text-white">
                        + Add Patient
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-800">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Age</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Gender</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Notes</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody" class="divide-y divide-gray-800">
                            <!-- Populated via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Modal -->
    <div id="patientModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="card max-w-md w-full mx-4">
            <h3 id="modalTitle" class="text-2xl font-bold mb-6 gradient-text">Add New Patient</h3>
            <form id="patientForm" class="space-y-4">
                <input type="hidden" id="patientId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Name</label>
                    <input type="text" id="patientName" required
                           class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-cyan-400 focus:outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Age</label>
                        <input type="number" id="patientAge" required min="1" max="120"
                               class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Gender</label>
                        <select id="patientGender" required
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-cyan-400 focus:outline-none">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Diagnosis Level</label>
                    <select id="patientLevel" required
                            class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-cyan-400 focus:outline-none">
                        <option value="Level 1">Level 1</option>
                        <option value="Level 2">Level 2</option>
                        <option value="Level 3">Level 3</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">Notes</label>
                    <textarea id="patientNotes" rows="3"
                              class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg focus:border-cyan-400 focus:outline-none"></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 btn-gradient text-white">Save</button>
                    <button type="button" onclick="hidePatientModal()" 
                            class="flex-1 px-4 py-2 border border-gray-700 rounded-lg hover:bg-gray-900 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication check
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            window.location.href = '/login';
        }

        // Global variables
        let ws = null;
        let focusChart = null;
        let stressChart = null;
        const maxDataPoints = 50;

        // Initialize charts - FIXED: Proper configuration to prevent zoom issues
        function initCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CRITICAL: Prevents auto-resize issues
                    animation: false, // Disable animations for better performance
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(139, 92, 246, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#9ca3af',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            };

            // Focus Chart
            focusChart = new Chart(document.getElementById('focusChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Focus',
                        data: [],
                        borderColor: '#00f5ff',
                        backgroundColor: 'rgba(0, 245, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...chartConfig.options,
                    scales: {
                        ...chartConfig.options.scales,
                        y: {
                            ...chartConfig.options.scales.y,
                            min: 0,
                            max: 1
                        }
                    }
                }
            });

            // Stress Chart
            stressChart = new Chart(document.getElementById('stressChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Stress',
                        data: [],
                        borderColor: '#ff006e',
                        backgroundColor: 'rgba(255, 0, 110, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                }
            });
        }

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);

            ws.onopen = () => {
                console.log('Dashboard connected to WebSocket');
                document.getElementById('connectionIndicator').classList.remove('connection-inactive');
                document.getElementById('connectionIndicator').classList.add('connection-active');
                document.getElementById('connectionStatus').textContent = 'Connected - Waiting for session...';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'sensor_update') {
                    updateDashboard(message.data);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('connectionIndicator').classList.remove('connection-active');
                document.getElementById('connectionIndicator').classList.add('connection-inactive');
                document.getElementById('connectionStatus').textContent = 'Disconnected - Reconnecting...';
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Update dashboard with sensor data
        function updateDashboard(data) {
            // Update connection status
            document.getElementById('connectionStatus').textContent = `Active Session - Patient ID: ${data.patient_id}`;
            document.getElementById('sessionInfo').textContent = `Session: ${data.session_id}`;

            // Update body parts
            for (const [partName, partData] of Object.entries(data.body_status)) {
                const element = document.getElementById(`part-${partName}`);
                if (element) {
                    element.classList.remove('status-normal', 'status-elevated', 'status-warning', 'status-critical');
                    element.classList.add(`status-${partData.color}`);
                }
            }

            // Update global metrics
            document.getElementById('focusLevel').textContent = data.global_stats.focus_level.toFixed(2);
            document.getElementById('maxStress').textContent = data.global_stats.max_stress.toFixed(2);
            document.getElementById('maxTremor').textContent = data.global_stats.max_tremor.toFixed(2);
            document.getElementById('avgStress').textContent = data.global_stats.avg_stress.toFixed(2);

            // Update AI recommendations
            const ai = data.ai_command;
            const severityClass = `badge-${ai.severity}`;
            document.getElementById('aiRecommendations').innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="badge ${severityClass}">${ai.severity.toUpperCase()}</div>
                    <div class="flex-1">
                        <div class="font-semibold mb-1">Command: ${ai.command}</div>
                        <div class="text-sm text-gray-400">${ai.reason}</div>
                        ${ai.target_sensor ? `<div class="text-xs text-gray-500 mt-1">Target: ${ai.target_sensor}</div>` : ''}
                    </div>
                </div>
            `;

            // Update charts with throttling
            updateCharts(data);
        }

        // FIXED: Throttled chart updates to prevent infinite zoom
        let lastChartUpdate = 0;
        const chartUpdateInterval = 100; // Update every 100ms maximum

        function updateCharts(data) {
            const now = Date.now();
            if (now - lastChartUpdate < chartUpdateInterval) {
                return; // Skip update if too frequent
            }
            lastChartUpdate = now;

            const timestamp = new Date().toLocaleTimeString();

            // Update focus chart
            focusChart.data.labels.push(timestamp);
            focusChart.data.datasets[0].data.push(data.global_stats.focus_level);
            if (focusChart.data.labels.length > maxDataPoints) {
                focusChart.data.labels.shift();
                focusChart.data.datasets[0].data.shift();
            }
            focusChart.update('none'); // 'none' mode = no animation, prevents flickering

            // Update stress chart
            stressChart.data.labels.push(timestamp);
            stressChart.data.datasets[0].data.push(data.global_stats.max_stress);
            if (stressChart.data.labels.length > maxDataPoints) {
                stressChart.data.labels.shift();
                stressChart.data.datasets[0].data.shift();
            }
            stressChart.update('none');
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');

            if (tabName === 'patients') {
                loadPatients();
            }
        }

        // Patient management
        async function loadPatients() {
            try {
                const response = await fetch('/api/patients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const patients = await response.json();
                
                document.getElementById('patientsTableBody').innerHTML = patients.map(p => `
                    <tr class="hover:bg-gray-900 transition">
                        <td class="px-6 py-4 text-sm">${p.id}</td>
                        <td class="px-6 py-4 text-sm font-medium">${p.name}</td>
                        <td class="px-6 py-4 text-sm">${p.age}</td>
                        <td class="px-6 py-4 text-sm">${p.gender}</td>
                        <td class="px-6 py-4 text-sm">${p.diagnosis_level}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${p.notes || '-'}</td>
                        <td class="px-6 py-4 text-sm space-x-2">
                            <button onclick="editPatient(${p.id})" class="text-cyan-400 hover:text-cyan-300">Edit</button>
                            <button onclick="deletePatient(${p.id})" class="text-pink-500 hover:text-pink-400">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        function showAddPatientModal() {
            document.getElementById('modalTitle').textContent = 'Add New Patient';
            document.getElementById('patientForm').reset();
            document.getElementById('patientId').value = '';
            document.getElementById('patientModal').classList.remove('hidden');
        }

        function hidePatientModal() {
            document.getElementById('patientModal').classList.add('hidden');
        }

        async function editPatient(id) {
            try {
                const response = await fetch('/api/patients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const patients = await response.json();
                const patient = patients.find(p => p.id === id);
                
                if (patient) {
                    document.getElementById('modalTitle').textContent = 'Edit Patient';
                    document.getElementById('patientId').value = patient.id;
                    document.getElementById('patientName').value = patient.name;
                    document.getElementById('patientAge').value = patient.age;
                    document.getElementById('patientGender').value = patient.gender;
                    document.getElementById('patientLevel').value = patient.diagnosis_level;
                    document.getElementById('patientNotes').value = patient.notes || '';
                    document.getElementById('patientModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading patient:', error);
            }
        }

        async function deletePatient(id) {
            if (!confirm('Are you sure you want to delete this patient?')) return;
            
            try {
                await fetch(`/api/patients/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPatients();
            } catch (error) {
                console.error('Error deleting patient:', error);
            }
        }

        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const patientData = {
                name: document.getElementById('patientName').value,
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                diagnosis_level: document.getElementById('patientLevel').value,
                notes: document.getElementById('patientNotes').value
            };

            const patientId = document.getElementById('patientId').value;
            
            try {
                if (patientId) {
                    await fetch(`/api/patients/${patientId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(patientData)
                    });
                } else {
                    await fetch('/api/patients', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(patientData)
                    });
                }
                
                hidePatientModal();
                loadPatients();
            } catch (error) {
                console.error('Error saving patient:', error);
            }
        });

        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/login';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            connectWebSocket();
        });
    </script>
</body>
</html>
