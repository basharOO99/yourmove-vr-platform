<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YourMove Clinical Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ── Reset & root ─────────────────────────────────────────── */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  /* ─ Brand ─ */
  --cyan:   #00F5FF;
  --purple: #8B5CF6;
  --pink:   #FF006E;
  /* ─ Backgrounds ─ */
  --bg:     #0B0F1A;
  --p1:     #141B2D;
  --p2:     #1C2436;
  --p3:     #222d42;
  /* ─ Accent ─ */
  --acc:    #00F5FF;
  --acc2:   #00c8d4;
  /* ─ Risk ─ */
  --crit:   #DC2626;
  --high:   #EF4444;
  --amber:  #F59E0B;
  --mod:    #8B5CF6;
  --low:    #10B981;
  --safe:   #00F5FF;
  /* ─ Text ─ */
  --text:   #E6EDF7;
  --t2:     #94A3B8;
  --t3:     #4A5568;
  /* ─ Borders ─ */
  --bdr:    rgba(255,255,255,0.07);
  --bdr2:   rgba(0,245,255,0.18);
  --shadow: 0 1px 3px rgba(0,0,0,.5);
  /* ─ Gradients ─ */
  --grad-brand: linear-gradient(135deg,#00F5FF 0%,#8B5CF6 55%,#FF006E 100%);
  --grad-cyan:  linear-gradient(135deg,#00F5FF,#8B5CF6);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:13px;line-height:1.5;min-height:100vh}
.mono{font-family:'DM Mono',monospace!important}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--p1)}
::-webkit-scrollbar-thumb{background:rgba(0,245,255,.2);border-radius:2px}

/* ── Layout primitives ──────────────────────────────────────── */
.panel{background:var(--p1);border:1px solid var(--bdr);border-radius:6px}
.panel-inner{background:var(--p2);border:1px solid var(--bdr);border-radius:4px}
.hidden{display:none!important}
.mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum"}

/* ── Navbar ──────────────────────────────────────────────────── */
.navbar{background:var(--p1);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:100;height:44px}
.nav-inner{max-width:100%;padding:0 16px;height:100%;display:flex;align-items:center;justify-content:space-between;gap:12px}
.nav-brand{display:flex;align-items:center;gap:8px;text-decoration:none}
.nav-brand-text{font-size:14px;font-weight:700;letter-spacing:-.01em;color:var(--text)}
.nav-brand-sub{font-size:11px;color:var(--t3);font-weight:400}

/* ── Tab bar ─────────────────────────────────────────────────── */
.tabbar{background:var(--p1);border-bottom:1px solid var(--bdr);padding:0 16px}
.tab-btn{display:inline-flex;align-items:center;gap:5px;padding:8px 12px;font-size:12px;font-weight:500;color:var(--t3);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;transition:color .15s,border-color .15s}
.tab-btn:hover{color:var(--t2)}
.tab-active{color:var(--cyan)!important;border-bottom-color:var(--cyan)!important}

/* ── Buttons ─────────────────────────────────────────────────── */
.btn-primary{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:var(--grad-cyan);color:#000;border:none;border-radius:4px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity .15s}
.btn-primary:hover{opacity:.88}
.btn-secondary{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;background:transparent;color:var(--t2);border:1px solid var(--bdr);border-radius:4px;font-size:12px;font-weight:500;cursor:pointer;transition:border-color .15s,color .15s}
.btn-secondary:hover{color:var(--cyan);border-color:rgba(0,245,255,.35)}
.btn-danger{padding:5px 12px;background:rgba(220,38,38,.1);color:#fca5a5;border:1px solid rgba(220,38,38,.22);border-radius:4px;font-size:11px;cursor:pointer;transition:all .15s}
.btn-danger:hover{background:rgba(220,38,38,.2)}

/* ── Section labels ──────────────────────────────────────────── */
.section-label{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--t3)}
.section-label-acc{color:var(--cyan)}

/* ── Metric cards ────────────────────────────────────────────── */
.metric-card{padding:10px 12px;display:flex;flex-direction:column;gap:3px}
.metric-val{font-size:22px;font-weight:700;font-variant-numeric:tabular-nums;letter-spacing:-.02em;line-height:1}
.metric-lbl{font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.07em;color:var(--t3)}
.metric-delta{font-size:10px;font-weight:600;display:flex;align-items:center;gap:2px}
.delta-up{color:#ef4444}.delta-dn{color:#22c55e}.delta-stable{color:var(--t3)}
.metric-bar{height:2px;background:rgba(255,255,255,.06);border-radius:1px;overflow:hidden;margin-top:4px}
.metric-fill{height:100%;border-radius:1px;transition:width .6s ease}

/* ── Status / Risk badges ────────────────────────────────────── */
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;white-space:nowrap}
.b-critical{background:rgba(220,38,38,.15);color:#fca5a5;border:1px solid rgba(220,38,38,.3)}
.b-high    {background:rgba(239,68,68,.13); color:#fda4af;border:1px solid rgba(239,68,68,.28)}
.b-moderate{background:rgba(139,92,246,.13);color:#c4b5fd;border:1px solid rgba(139,92,246,.28)}
.b-low     {background:rgba(16,185,129,.13);color:#6ee7b7;border:1px solid rgba(16,185,129,.28)}

.risk-CRITICAL{background:rgba(220,38,38,.18);color:#f87171;border:1px solid rgba(220,38,38,.4);font-size:11px;padding:3px 10px;animation:pulse-risk 1.4s ease-in-out infinite}
.risk-HIGH    {background:rgba(239,68,68,.15); color:#fca5a5;border:1px solid rgba(239,68,68,.35)}
.risk-MODERATE{background:rgba(139,92,246,.14);color:#c4b5fd;border:1px solid rgba(139,92,246,.3)}
.risk-LOW     {background:rgba(16,185,129,.13);color:#6ee7b7;border:1px solid rgba(16,185,129,.3)}
@keyframes pulse-risk{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.3)}50%{box-shadow:0 0 0 5px rgba(220,38,38,0)}}

/* ── Connection indicator ────────────────────────────────────── */
.cdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.cdot-on {background:#00F5FF;box-shadow:0 0 5px rgba(0,245,255,.5);animation:blink-c 2.5s ease-in-out infinite}
.cdot-off{background:var(--t3)}
@keyframes blink-c{0%,100%{opacity:1}50%{opacity:.35}}

/* ── Body map segments ───────────────────────────────────────── */
#mapSvg .seg{cursor:pointer;transition:fill .35s ease,filter .35s ease}
.s-normal  {fill:#0d2233}
.s-mild    {fill:#0c3322}
.s-elevated{fill:#332b08}
.s-warning {fill:#3d1a08}
.s-critical{fill:#3d0808;animation:crit-pulse .8s ease-in-out infinite alternate}
@keyframes crit-pulse{from{filter:brightness(1)}to{filter:brightness(1.7) saturate(1.3)}}
#mapSvg .seg:hover{opacity:.7}

/* ── Stability gauge ─────────────────────────────────────────── */
#stabArc{transform:rotate(-90deg);transform-origin:55px 55px;transition:stroke-dashoffset .7s ease,stroke .7s ease}

/* ── Chart wrappers ──────────────────────────────────────────── */
.chart-wrap{position:relative;height:280px;width:100%}

/* ── AI event log ────────────────────────────────────────────── */
.ai-event{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border-radius:4px;background:rgba(255,255,255,.018);border-left:2px solid transparent;animation:fadein .2s ease}
.ai-event.ec{border-left-color:var(--crit)}.ai-event.eh{border-left-color:var(--high)}.ai-event.em{border-left-color:var(--acc)}.ai-event.el{border-left-color:var(--t3)}
@keyframes fadein{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:none}}

/* ── Anomaly events ──────────────────────────────────────────── */
.anomaly-row{padding:5px 8px;border-radius:3px;border:1px solid var(--bdr);background:rgba(255,255,255,.013)}

/* ── Tables ──────────────────────────────────────────────────── */
table{width:100%;border-collapse:collapse}
th{font-size:10px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;color:var(--t3);padding:6px 8px;text-align:left;background:rgba(255,255,255,.018);border-bottom:1px solid var(--bdr)}
td{font-size:12px;padding:5px 8px;border-bottom:1px solid rgba(255,255,255,.03)}
tr:hover td{background:rgba(255,255,255,.014)}

/* ── Form inputs ─────────────────────────────────────────────── */
.form-input{width:100%;padding:6px 10px;background:rgba(0,0,0,.3);border:1px solid var(--bdr);border-radius:4px;font-size:12px;color:var(--text);outline:none;transition:border-color .15s;font-family:'DM Sans',sans-serif}
.form-input:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,245,255,.10)}
.form-input::placeholder{color:var(--t3)}
.form-label{display:block;font-size:10px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--t3);margin-bottom:4px}

/* ── Modal overlay ───────────────────────────────────────────── */
.modal-bg{background:rgba(0,0,0,.72);backdrop-filter:blur(8px)}

/* ── Prediction bars ─────────────────────────────────────────── */
.pred-bar-bg{height:4px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin-top:3px}
.pred-bar   {height:100%;border-radius:2px;background:var(--cyan);transition:width .5s}

/* ── Empty states ────────────────────────────────────────────── */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 12px;color:var(--t3);gap:6px;text-align:center}
.empty svg{opacity:.3}
.empty p{font-size:12px}

/* ── Region rank ─────────────────────────────────────────────── */
.region-bar{height:3px;border-radius:2px;background:rgba(255,255,255,.06);overflow:hidden;margin-top:2px}
.region-fill{height:100%;border-radius:2px;transition:width .5s ease;background:var(--cyan)}

/* ── Trend arrows ────────────────────────────────────────────── */
.t-up{color:#EF4444;font-size:10px;font-weight:700}
.t-dn{color:#10B981;font-size:10px;font-weight:700}
.t-st{color:var(--t3);font-size:10px}

/* ═══════════════════════════════════════════════════════
   PRINT STYLES — Clinical PDF Export
   ═══════════════════════════════════════════════════════ */
@media print{
  body{background:#fff!important;color:#111!important;font-size:11px}
  .navbar,.tabbar,.no-print{display:none!important}
  #content-patients,#content-history{display:none!important}
  .panel{background:#f8f9fa!important;border:1px solid #e2e8f0!important;page-break-inside:avoid}
  .metric-val{color:#111!important}
  .section-label,.metric-lbl{color:#475569!important}
  .chart-wrap{height:200px!important}
  .print-header{display:block!important}
  #content-monitor{display:block!important}
  canvas{max-width:100%}
  .print-break{page-break-before:always}
  .modal-bg{display:none!important}
  .t2,.t3{color:#475569!important}
}
.print-header{display:none;border-bottom:2px solid #e2e8f0;padding-bottom:10px;margin-bottom:14px}
/* ── Logo Image ─────────────────────────────────────────── */
.logo-img{
  height:32px;
  width:auto;
  object-fit:contain;
  display:block;
  background:transparent;
}
</style>
</head>
<body>

<!-- ══ NAVBAR ═════════════════════════════════════════════════════════════ -->
<nav class="navbar">
  <div class="nav-inner">
    <div class="flex items-center gap-5">
      <a class="nav-brand" href="/">
      <img src="{{ url_for('static', path='images/yourmove-logo.png') }}"
     alt="YourMove Logo"
     style="width:42px;height:42px;object-fit:contain;">
        <div>
          <div class="nav-brand-text">YourMove</div>
          <div class="nav-brand-sub">Clinical Analytics Platform</div>
        </div>
      </a>
    </div>
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-1.5">
        <div id="cdot" class="cdot cdot-off"></div>
        <span id="connLabel" class="text-xs" style="color:var(--t3)">Disconnected</span>
      </div>
      <div class="hidden sm:block text-right">
        <div class="text-xs font-medium" id="doctorName"></div>
        <div class="text-xs" id="doctorRole" style="color:var(--t3)"></div>
      </div>
      <button onclick="exportPDF()" class="btn-secondary no-print" title="Export session report">
        <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Export PDF
      </button>
      <button onclick="logout()" class="text-xs" style="color:var(--t3)">Sign Out</button>
    </div>
  </div>
</nav>

<!-- ══ TAB BAR ═══════════════════════════════════════════════════════════ -->
<div class="tabbar no-print">
  <div class="flex overflow-x-auto">
    <button id="tab-monitor"  onclick="showTab('monitor')"  class="tab-btn tab-active">Live Monitor</button>
    <button id="tab-compare"  onclick="showTab('compare')"  class="tab-btn">Historical Comparison</button>
    <button id="tab-patients" onclick="showTab('patients')" class="tab-btn">Patient Registry</button>
    <button id="tab-history"  onclick="showTab('history')"  class="tab-btn">Session History</button>
  </div>
</div>

<!-- ══ PRINT HEADER ═══════════════════════════════════════════════════════ -->
<div class="print-header px-4 pt-3">
  <div class="flex justify-between items-start">
    <div>
      <h1 style="font-size:16px;font-weight:700">YourMove Clinical Session Report</h1>
      <p style="font-size:11px;color:#475569" id="printMeta"></p>
    </div>
    <div style="font-size:10px;color:#94a3b8;text-align:right">
      Generated: <span id="printDate"></span><br>
      Clinician: <span id="printDoc"></span>
    </div>
  </div>
</div>

<!-- ══ MAIN ══════════════════════════════════════════════════════════════ -->
<div class="px-3 py-3 max-w-screen-2xl mx-auto">

<!--   LIVE MONITOR TAB   ────────────────────────────────────────────────────────────── -->
                                    
     
<div id="content-monitor">

  <!-- Status bar -->
  <div class="panel mb-3 px-3 py-2 flex flex-wrap items-center justify-between gap-2">
    <div class="flex items-center gap-3">
      <div id="riskBadge" class="badge risk-LOW">LOW</div>
      <div>
        <div class="text-xs font-semibold" id="sessionTitle">No active session</div>
        <div class="text-xs mono" id="sessionSub" style="color:var(--t3)"></div>
      </div>
    </div>
    <div class="flex items-center gap-4 flex-wrap">
      <div id="anomalyBanner" class="hidden badge b-critical">⚑ ANOMALY DETECTED</div>
      <div class="text-xs mono" id="durationLabel" style="color:var(--t3)"></div>
      <div class="text-xs mono" id="frameLabel" style="color:var(--t3)"></div>
    </div>
  </div>

  <!-- ── Row 1: 5 metric cards ──────────────────────────────────────── -->
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 mb-3">
    <div class="panel metric-card">
      <div class="section-label">Focus </div>
      <div class="flex items-end gap-2">
        <div class="metric-val mono" id="mFocus" style="color:var(--cyan)">—</div>
        <div id="dFocus" class="metric-delta delta-stable mb-0.5">—</div>
      </div>
      <div class="metric-bar"><div class="metric-fill" id="bFocus" style="width:0%;background:var(--cyan)"></div></div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Max Stress</div>
      <div class="flex items-end gap-2">
        <div class="metric-val mono" id="mStress" style="color:#f87171">—</div>
        <div id="dStress" class="metric-delta delta-stable mb-0.5">—</div>
      </div>
      <div class="metric-bar"><div class="metric-fill" id="bStress" style="width:0%;background:#ef4444"></div></div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Avg vibration</div>
      <div class="flex items-end gap-2">
        <div class="metric-val mono" id="mAvgStress" style="color:#fb923c">—</div>
        <div id="dAvgStress" class="metric-delta delta-stable mb-0.5">—</div>
      </div>
      <div class="metric-bar"><div class="metric-fill" id="bAvgStress" style="width:0%;background:#ea580c"></div></div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Max Tremor</div>
      <div class="flex items-end gap-2">
        <div class="metric-val mono" id="mTremor" style="color:#c084fc">—</div>
        <div id="dTremor" class="metric-delta delta-stable mb-0.5">—</div>
      </div>
      <div class="metric-bar"><div class="metric-fill" id="bTremor" style="width:0%;background:#a855f7"></div></div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">AI Confidence</div>
      <div class="metric-val mono" id="mConf" style="color:var(--cyan)">—</div>
      <div class="metric-bar"><div class="metric-fill" id="bConf" style="width:0%;background:var(--cyan)"></div></div>
      <div class="metric-lbl" id="mConfLabel">Insufficient data</div>
    </div>
  </div>

  <!-- ── Row 2: body map | intelligence panel | charts ─────────────── -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-3 mb-3">

    <!-- Body Map (3 cols) -->
    <div class="panel xl:col-span-3 p-3 flex flex-col gap-2">
      <div class="flex items-center justify-between">
        <div class="section-label">Body  Map</div>
        <div class="text-xs" style="color:var(--t3)">13 sensors</div>
      </div>
      <div class="flex justify-center">
        <svg id="mapSvg" viewBox="0 0 220 380" width="160" xmlns="http://www.w3.org/2000/svg">
          <!-- Skeleton lines -->
          <g stroke="#1e2840" stroke-width="1.5" fill="none">
            <line x1="110" y1="82"  x2="110" y2="108"/>
            <line x1="110" y1="120" x2="110" y2="158"/>
            <line x1="110" y1="118" x2="70"  y2="118"/>
            <line x1="110" y1="118" x2="150" y2="118"/>
            <line x1="70"  y1="162" x2="52"  y2="200"/>
            <line x1="150" y1="162" x2="168" y2="200"/>
            <line x1="104" y1="164" x2="96"  y2="220"/>
            <line x1="116" y1="164" x2="124" y2="220"/>
            <line x1="96"  y1="282" x2="96"  y2="335"/>
            <line x1="124" y1="282" x2="124" y2="335"/>
          </g>
          <!-- HEAD -->
          <ellipse class="seg s-normal" id="part-head" cx="110" cy="46" rx="28" ry="32"/>
          <ellipse cx="102" cy="42" rx="3" ry="3.5" fill="rgba(0,0,0,.25)"/>
          <ellipse cx="118" cy="42" rx="3" ry="3.5" fill="rgba(0,0,0,.25)"/>
          <!-- CHEST -->
          <rect class="seg s-normal" id="part-chest" x="84" y="108" width="52" height="54" rx="10"/>
          <!-- HIP -->
          <rect class="seg s-normal" id="part-hip" x="89" y="165" width="42" height="27" rx="9"/>
          <!-- ARMS -->
          <rect class="seg s-normal" id="part-left_upper_arm"  x="57" y="112" width="21" height="48" rx="10" transform="rotate(-7 67 136)"/>
          <rect class="seg s-normal" id="part-right_upper_arm" x="142" y="112" width="21" height="48" rx="10" transform="rotate(7 153 136)"/>
          <rect class="seg s-normal" id="part-left_lower_arm"  x="46" y="162" width="18" height="50" rx="9" transform="rotate(-11 55 187)"/>
          <rect class="seg s-normal" id="part-right_lower_arm" x="156" y="162" width="18" height="50" rx="9" transform="rotate(11 165 187)"/>
          <!-- HANDS -->
          <ellipse class="seg s-normal" id="part-left_hand"  cx="42"  cy="222" rx="12" ry="9"/>
          <ellipse class="seg s-normal" id="part-right_hand" cx="178" cy="222" rx="12" ry="9"/>
          <!-- LEGS -->
          <rect class="seg s-normal" id="part-left_upper_leg"  x="85"  y="196" width="22" height="85" rx="11"/>
          <rect class="seg s-normal" id="part-right_upper_leg" x="113" y="196" width="22" height="85" rx="11"/>
          <rect class="seg s-normal" id="part-left_lower_leg"  x="84"  y="283" width="20" height="72" rx="10"/>
          <rect class="seg s-normal" id="part-right_lower_leg" x="116" y="283" width="20" height="72" rx="10"/>
          <!-- Feet -->
          <ellipse cx="94"  cy="362" rx="16" ry="7" fill="#111827"/>
          <ellipse cx="126" cy="362" rx="16" ry="7" fill="#111827"/>
        </svg>
      </div>

      <!-- Tooltip -->
      <div id="bodyTip" class="text-center mono" style="font-size:10px;color:var(--t3);min-height:14px"></div>

      <!-- Legend -->
      <div class="grid grid-cols-2 gap-x-3 gap-y-1.5 pt-1" style="border-top:1px solid var(--bdr)">
        <div class="flex items-center gap-1.5 text-xs" style="color:var(--t3)"><span style="width:8px;height:8px;border-radius:2px;background:#1e3a4a;flex-shrink:0;display:inline-block"></span>Normal</div>
        <div class="flex items-center gap-1.5 text-xs" style="color:var(--t3)"><span style="width:8px;height:8px;border-radius:2px;background:#1d4038;flex-shrink:0;display:inline-block"></span>Mild</div>
        <div class="flex items-center gap-1.5 text-xs" style="color:var(--t3)"><span style="width:8px;height:8px;border-radius:2px;background:#3d3010;flex-shrink:0;display:inline-block"></span>Elevated</div>
        <div class="flex items-center gap-1.5 text-xs" style="color:var(--t3)"><span style="width:8px;height:8px;border-radius:2px;background:#4a2210;flex-shrink:0;display:inline-block"></span>Warning</div>
        <div class="flex items-center gap-1.5 text-xs" style="color:var(--t3)"><span style="width:8px;height:8px;border-radius:2px;background:#4a0e0e;flex-shrink:0;display:inline-block"></span>Critical</div>
      </div>
    </div>

    <!-- Clinical Intelligence Panel (4 cols) -->
    <div class="xl:col-span-4 flex flex-col gap-2">

      <!-- Stability + Risk -->
      <div class="panel p-3 flex gap-4 items-center">
        <!-- Stability gauge -->
        <div class="relative flex-shrink-0" style="width:92px;height:92px">
          <svg width="92" height="92" viewBox="0 0 110 110">
            <circle cx="55" cy="55" r="46" fill="none" stroke="rgba(255,255,255,.05)" stroke-width="9"/>
            <circle id="stabArc" cx="55" cy="55" r="46" fill="none"
                    stroke="#00F5FF" stroke-width="9" stroke-linecap="butt"
                    stroke-dasharray="289" stroke-dashoffset="289"/>
          </svg>
          <div class="absolute inset-0 flex flex-col items-center justify-center">
            <div id="stabVal" class="text-lg font-bold mono" style="color:var(--acc);line-height:1">—</div>
            <div class="text-xs" style="color:var(--t3)">Stability</div>
          </div>
        </div>
        <div class="flex-1 flex flex-col gap-2">
          <div>
            <div class="section-label mb-1">Risk Classification</div>
            <div id="riskBadgeBig" class="badge risk-LOW" style="font-size:11px;padding:3px 10px">LOW RISK</div>
          </div>
          <div>
            <div class="flex justify-between mb-1">
              <span class="section-label">AI Confidence</span>
              <span id="confPct" class="mono text-xs" style="color:var(--cyan)">—</span>
            </div>
            <div class="metric-bar" style="height:3px"><div class="metric-fill" id="bigConfBar" style="width:0%;background:var(--cyan)"></div></div>
          </div>
          <div class="flex gap-3 pt-1" style="border-top:1px solid var(--bdr)">
            <div>
              <div class="section-label">Trend</div>
              <div id="trendLabel" class="text-xs font-semibold t-st mt-0.5">— stable</div>
            </div>
            <div>
              <div class="section-label">Escalation</div>
              <div class="flex gap-1 mt-1" id="escalDots">
                <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
                <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
                <div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.06)"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Predictive model -->
      <div class="panel p-3">
        <div class="section-label mb-2">Predictive Stress Forecast</div>
        <div class="grid grid-cols-3 gap-2">
          <div class="panel-inner p-2">
            <div class="section-label" style="font-size:9px">30 sec</div>
            <div id="pred30" class="text-base font-bold mono mt-0.5" style="color:var(--t2)">—</div>
            <div id="pred30trend" class="t-st text-xs">—</div>
            <div class="pred-bar-bg"><div class="pred-bar" id="pred30bar" style="width:0%"></div></div>
          </div>
          <div class="panel-inner p-2">
            <div class="section-label" style="font-size:9px">60 sec</div>
            <div id="pred60" class="text-base font-bold mono mt-0.5" style="color:var(--t2)">—</div>
            <div id="pred60trend" class="t-st text-xs">—</div>
            <div class="pred-bar-bg"><div class="pred-bar" id="pred60bar" style="width:0%"></div></div>
          </div>
          <div class="panel-inner p-2">
            <div class="section-label" style="font-size:9px">120 sec</div>
            <div id="pred120" class="text-base font-bold mono mt-0.5" style="color:var(--t2)">—</div>
            <div id="pred120trend" class="t-st text-xs">—</div>
            <div class="pred-bar-bg"><div class="pred-bar" id="pred120bar" style="width:0%"></div></div>
          </div>
        </div>
        <div id="predWarning" class="hidden mt-2 text-xs px-2 py-1.5 rounded" style="background:rgba(220,38,38,.1);color:#fca5a5;border:1px solid rgba(220,38,38,.2)"></div>
      </div>

      <!-- Clinical action -->
      <div id="clinActionPanel" class="panel p-3">
        <div class="section-label mb-1.5">Clinical Guidance</div>
        <div id="clinActionText" class="text-xs leading-relaxed" style="color:var(--t2)">Awaiting session data…</div>
      </div>

      <!-- Session info -->
      <div class="panel p-3">
        <div class="section-label mb-2">Session Information</div>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1.5">
          <div><div class="section-label" style="font-size:9px">Patient ID</div><div class="text-xs mono font-medium" id="infoPatient" style="color:var(--t2)">—</div></div>
          <div><div class="section-label" style="font-size:9px">Session ID</div><div class="text-xs mono truncate" id="infoSession" style="color:var(--t2)">—</div></div>
          <div><div class="section-label" style="font-size:9px">Duration</div><div class="text-xs mono font-bold" id="infoDuration" style="color:var(--cyan)">—</div></div>
          <div><div class="section-label" style="font-size:9px">Frames</div><div class="text-xs mono" id="infoFrames" style="color:var(--t3)">—</div></div>
        </div>
      </div>
    </div>

    <!-- AI Current Command + Top Regions (5 cols) -->
    <div class="xl:col-span-5 flex flex-col gap-2">

      <!-- Current AI Command (replaces log) -->
      <div class="panel p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="section-label">Current AI Command</div>
          <span id="aiLastTs" class="mono" style="font-size:9px;color:var(--t3)"></span>
        </div>
        <!-- Command card -->
        <div id="aiCmdCard" style="border:1px solid var(--bdr);border-radius:5px;padding:10px 12px;background:rgba(0,0,0,.2)">
          <div class="flex items-center gap-2 mb-1">
            <span id="aiCmdBadge" class="badge b-low">low</span>
            <span id="aiCmdName" class="text-sm font-semibold" style="color:var(--text)">Awaiting session…</span>
          </div>
          <div id="aiCmdReason" class="text-xs leading-relaxed" style="color:var(--t3)">No active session. Connect UE5 to begin receiving commands.</div>
        </div>
      </div>

      <!-- Anomaly events -->
      <div class="panel p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="section-label">Statistical Anomalies</div>
          <span id="anomCount" class="text-xs" style="color:var(--t3)">0 detected</span>
        </div>
        <div id="anomList" class="flex flex-col gap-1">
          <div class="empty" style="padding:10px">
            <p>No anomalies detected</p>
          </div>
        </div>
      </div>

      <!-- Top Affected Regions -->
      <div class="panel p-3">
        <div class="section-label mb-2">Top Affected Regions</div>
        <div id="regionList" class="flex flex-col gap-2">
          <div class="empty" style="padding:8px"><p>No session active</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Row 3: Charts ───────────────────────────────────────────────── -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">

    <!-- Focus chart -->
    <div class="panel p-3">
      <div class="flex items-center justify-between mb-2">
        <div>
          <div class="section-label section-label-acc">Focus Index Over Time</div>
          <div class="text-xs mt-0.5" style="color:var(--t3)">Eye-tracking attention score · Threshold: 0.60</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-1.5">
            <div style="width:14px;height:2px;background:#00F5FF"></div>
            <span class="text-xs" style="color:var(--t3)">Live</span>
          </div>
          <div id="focusLast" class="mono text-xs font-bold" style="color:var(--cyan)">—</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="focusChart"></canvas></div>
    </div>

    <!-- Arousal chart -->
    <div class="panel p-3">
      <div class="flex items-center justify-between mb-2">
        <div>
          <div class="section-label" style="color:#ef4444">Max Arousal Over Time</div>
          <div class="text-xs mt-0.5" style="color:var(--t3)">Peak stress index · Alert: 10.0 · Critical: 15.0</div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-1.5">
            <div style="width:14px;height:2px;background:#ef4444"></div>
            <span class="text-xs" style="color:var(--t3)">Live</span>
          </div>
          <div id="stressLast" class="mono text-xs font-bold" style="color:#ef4444">—</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="stressChart"></canvas></div>
    </div>
  </div>

  <!-- ── Row 4: Session Summary ──────────────────────────────────────── -->
  <div class="panel p-3 mb-3">
    <div class="flex items-center justify-between mb-2">
      <div class="section-label">Auto-Generated Session Summary</div>
      <div class="text-xs" style="color:var(--t3)" id="summaryTs"></div>
    </div>
    <div id="sessionSummary" class="text-xs leading-relaxed" style="color:var(--t2)">
      Session summary will appear once data is received from the VR headset.
    </div>
  </div>

</div><!-- /monitor -->

<!--  HISTORICAL COMPARISON TAB      ────────────────────────────────────────────────── -->


<div id="content-compare" class="hidden">
  <div class="panel p-4 mb-3">
    <div class="section-label mb-3">Historical Session Comparison</div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
      <div><label class="form-label">Session A (baseline)</label>
        <input id="cmpSidA" placeholder="Session ID" class="form-input"></div>
      <div><label class="form-label">Patient A</label>
        <input id="cmpPidA" placeholder="Patient ID" class="form-input"></div>
      <div><label class="form-label">Session B (compare)</label>
        <input id="cmpSidB" placeholder="Session ID" class="form-input"></div>
      <div><label class="form-label">Patient B</label>
        <input id="cmpPidB" placeholder="Patient ID" class="form-input"></div>
    </div>
    <div class="flex gap-2 mb-2">
      <button onclick="runComparison()" class="btn-primary">Compare Sessions</button>
      <button onclick="clearComparison()" class="btn-secondary">Clear</button>
    </div>
    <div id="cmpStatus" class="text-xs mt-1" style="color:var(--t3)"></div>
  </div>

  <!-- Comparison summary cards -->
  <div id="cmpCards" class="hidden grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3">
    <div class="panel metric-card">
      <div class="section-label">Avg Focus — A</div>
      <div class="metric-val mono" id="cmpFocA" style="color:var(--cyan)">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Avg Focus — B</div>
      <div class="metric-val mono" id="cmpFocB" style="color:var(--cyan)">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Peak Stress — A</div>
      <div class="metric-val mono" id="cmpStrA" style="color:#ef4444">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Peak Stress — B</div>
      <div class="metric-val mono" id="cmpStrB" style="color:#ef4444">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Avg Tremor — A</div>
      <div class="metric-val mono" id="cmpTrA" style="color:#c084fc">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Avg Tremor — B</div>
      <div class="metric-val mono" id="cmpTrB" style="color:#c084fc">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Critical Events — A</div>
      <div class="metric-val mono" id="cmpCritA" style="color:var(--crit)">—</div>
    </div>
    <div class="panel metric-card">
      <div class="section-label">Critical Events — B</div>
      <div class="metric-val mono" id="cmpCritB" style="color:var(--crit)">—</div>
    </div>
  </div>

  <!-- Overlay charts -->
  <div id="cmpCharts" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">
    <div class="panel p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="section-label section-label-acc">Focus Index — Session Overlay</div>
        <div class="flex gap-3 text-xs">
          <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#00F5FF;display:inline-block"></span>Session A</span>
          <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#f59e0b;display:inline-block"></span>Session B</span>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="cmpFocusChart"></canvas></div>
    </div>
    <div class="panel p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="section-label" style="color:#ef4444">Arousal Index — Session Overlay</div>
        <div class="flex gap-3 text-xs">
          <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#ef4444;display:inline-block"></span>Session A</span>
          <span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#f59e0b;display:inline-block"></span>Session B</span>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="cmpStressChart"></canvas></div>
    </div>
  </div>

  <!-- Outcome delta summary -->
  <div id="cmpDelta" class="hidden panel p-4">
    <div class="section-label mb-3">Clinical Outcome Delta (B vs A)</div>
    <div id="cmpDeltaBody" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
    <div class="mt-3 pt-3 text-xs leading-relaxed" id="cmpNarrative"
         style="border-top:1px solid var(--bdr);color:var(--t2)"></div>
  </div>
</div>

<!--  PATIENT REGISTRY TAB      ────────────────────────────────────────────────── -->

<div id="content-patients" class="hidden">
  <div class="panel p-4">
    <div class="flex justify-between items-center mb-4">
      <div>
        <div class="text-sm font-semibold">Patient Registry</div>
        <div class="text-xs mt-0.5" style="color:var(--t3)">Manage therapy participants</div>
      </div>
      <button onclick="showAddPt()" class="btn-primary">+ Register Patient</button>
    </div>
    <div class="overflow-x-auto">
      <table>
        <thead><tr>
          <th>ID</th><th>Name</th><th>Age</th><th>Gender</th>
          <th>ASD Level</th><th>Notes</th><th>Registered</th><th>Actions</th>
        </tr></thead>
        <tbody id="ptBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- SESSION HISTORY TAB      ────────────────────────────────────────────────── -->
<div id="content-history" class="hidden">
  <div class="panel p-4">
    <div class="section-label mb-3">Session History Query</div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
      <div><label class="form-label">Session ID</label><input id="hSID" placeholder="Any" class="form-input"></div>
      <div><label class="form-label">Patient ID</label><input id="hPID" placeholder="Any" class="form-input"></div>
      <div><label class="form-label">From</label><input id="hFrom" type="datetime-local" class="form-input"></div>
      <div><label class="form-label">To</label><input id="hTo" type="datetime-local" class="form-input"></div>
    </div>
    <div class="flex gap-2 mb-4">
      <button onclick="loadHistory()" class="btn-primary">Search Records</button>
      <button onclick="clearHist()" class="btn-secondary">Clear</button>
    </div>
    <div class="overflow-x-auto">
      <table>
        <thead><tr>
          <th>Timestamp</th><th>Session</th><th>Patient</th>
          <th>Focus%</th><th>Arousal%</th><th>Tremor</th>
          <th>AI Command</th><th>Severity</th>
        </tr></thead>
        <tbody id="hBody">
          <tr><td colspan="8"><div class="empty"><p>Run a query to load history</p></div></td></tr>
        </tbody>
      </table>
    </div>
    <div id="hCount" class="text-xs mt-2" style="color:var(--t3)"></div>
  </div>
</div>

</div><!-- /main -->

<!-- ══ PATIENT MODAL ══════════════════════════════════════════════════════ -->
<div id="ptModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg no-print">
  <div class="panel p-5 max-w-md w-full mx-4" style="border-color:rgba(59,130,246,.25)">
    <h3 id="ptModalTitle" class="text-sm font-semibold mb-4">Register Patient</h3>
    <form id="ptForm" class="flex flex-col gap-3">
      <input type="hidden" id="ptId">
      <div><label class="form-label">Full Name</label><input type="text" id="ptName" required class="form-input"></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="form-label">Age</label><input type="number" id="ptAge" required min="1" max="120" class="form-input"></div>
        <div><label class="form-label">Gender</label>
          <select id="ptGender" required class="form-input">
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
      </div>
      <div><label class="form-label">ASD Diagnosis Level</label>
        <select id="ptLevel" required class="form-input">
          <option>Level 1</option><option>Level 2</option><option>Level 3</option>
        </select>
      </div>
      <div><label class="form-label">Clinical Notes</label>
        <textarea id="ptNotes" rows="3" class="form-input" style="resize:none"></textarea>
      </div>
      <div class="flex gap-2 pt-1">
        <button type="submit" class="flex-1 btn-primary">Save Patient</button>
        <button type="button" onclick="hidePtModal()" class="flex-1 btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>

//  Constants & State

const token = localStorage.getItem('jwt_token');
if (!token) location.href = '/login';

const AUTH = { Authorization: `Bearer ${token}` };
let ws = null, wsDelay = 500;   // start fast, back off on repeated failure
let focusChart = null, stressChart = null;
let lastChart = 0;
const CHART_THR = 100;   // 10 fps max chart updates — was 160ms, snappier now
const MAX_PTS   = 80;

// Track current session to detect changes
let _currentSessionId = null;
let _prevFocus = null, _prevStress = null, _prevTremor = null, _prevAvg = null;

const BODY_LABELS = {
  head:'Head / Cranium', chest:'Thorax / Chest', hip:'Pelvis / Hip',
  left_upper_arm:'L. Proximal Arm', right_upper_arm:'R. Proximal Arm',
  left_lower_arm:'L. Forearm', right_lower_arm:'R. Forearm',
  left_hand:'Left Hand', right_hand:'Right Hand',
  left_upper_leg:'L. Proximal Leg', right_upper_leg:'R. Proximal Leg',
  left_lower_leg:'L. Distal Leg', right_lower_leg:'R. Distal Leg',
};

// Severity colour map
const SEV_CLS = {critical:'b-critical',high:'b-high',moderate:'b-moderate',low:'b-low'};
const RISK_COL = {CRITICAL:'#ef4444', HIGH:'#fbbf24', MODERATE:'#60a5fa', LOW:'#4ade80'};


//  Charts — medical style with threshold lines

Chart.register(window['chartjs-plugin-annotation']);

function makeChart(id, color, label, yMin, yMax, thresholds) {
  const ctx  = document.getElementById(id).getContext('2d');
  const grad = ctx.createLinearGradient(0, 0, 0, 280);
  grad.addColorStop(0, color + '28');
  grad.addColorStop(1, color + '00');

  // Build annotations for threshold lines
  const annotations = {};
  (thresholds || []).forEach((th, i) => {
    annotations[`thr${i}`] = {
      type: 'line',
      yMin: th.val, yMax: th.val,
      borderColor: th.color || 'rgba(220,38,38,.45)',
      borderWidth: 1,
      borderDash: [5, 4],
      label: {
        display: true,
        content: th.label,
        position: 'end',
        backgroundColor: 'transparent',
        color: th.color || 'rgba(220,38,38,.7)',
        font: { size: 9, weight: '600' },
        padding: { x: 4, y: 2 },
      }
    };
  });

  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label, data: [],
        borderColor: color, backgroundColor: grad,
        borderWidth: 1.8, fill: true, tension: 0.35,
        pointRadius: 0, pointHoverRadius: 4,
        pointHoverBackgroundColor: color,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        annotation: { annotations },
        tooltip: {
          backgroundColor: 'rgba(20,25,34,.97)',
          titleColor: '#94A3B8', bodyColor: '#E6EDF7',
          borderColor: 'rgba(59,130,246,.25)', borderWidth: 1,
          callbacks: {
            label: c => `${label}: ${c.parsed.y.toFixed(3)}`,
          }
        }
      },
      scales: {
        y: {
          min: yMin, max: yMax,
          grid:  { color: 'rgba(255,255,255,.04)' },
          ticks: { color: '#4A5568', font: { size: 9, family: 'DM Sans' }, maxTicksLimit: 6 },
          border: { color: 'rgba(255,255,255,.05)' }
        },
        x: {
          grid:  { display: false },
          ticks: { color: '#4A5568', font: { size: 9, family: 'DM Sans' }, maxTicksLimit: 10, maxRotation: 0 },
          border: { color: 'rgba(255,255,255,.05)' }
        }
      }
    }
  });
}

function initCharts() {
  focusChart = makeChart('focusChart', '#00F5FF', 'Focus', 0, 1, [
    { val: 0.6,  label: 'Alert (0.6)',  color: 'rgba(217,119,6,.55)' },
    { val: 0.35, label: 'Critical (0.35)', color: 'rgba(220,38,38,.55)' },
  ]);
  stressChart = makeChart('stressChart', '#ef4444', 'Arousal', 0, 25, [
    { val: 10.0, label: 'Alert (10)',   color: 'rgba(217,119,6,.55)' },
    { val: 15.0, label: 'Critical (15)', color: 'rgba(220,38,38,.55)' },
  ]);
}

function pushPt(chart, val) {
  const ts = new Date().toLocaleTimeString('en-GB', { hour12: false });
  chart.data.labels.push(ts);
  chart.data.datasets[0].data.push(val);
  if (chart.data.labels.length > MAX_PTS) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
}


//  WebSocket — fast initial connect, exponential back-off on failure

function connectWS() {
  if (ws && ws.readyState <= 1) return; // already open/connecting
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws/dashboard?token=${encodeURIComponent(token)}`);

  ws.onopen = () => {
    wsDelay = 500; // reset back-off on successful connect
    setConn(true, 'Connected');
  };

  ws.onmessage = e => {
    try {
      _wsLive = true;  // WS is delivering — REST poll can stop
      const msg = JSON.parse(e.data);
      if (msg.type === 'sensor_update') render(msg.data);
    } catch {}
  };

  ws.onclose = () => {
    setConn(false, `Reconnecting in ${(wsDelay / 1000).toFixed(1)}s…`);
    setTimeout(connectWS, wsDelay);
    wsDelay = Math.min(wsDelay * 1.8, 15000); // softer cap: 15s max
  };

  ws.onerror = () => ws.close();
}

function setConn(on, msg) {
  document.getElementById('cdot').className = `cdot ${on ? 'cdot-on' : 'cdot-off'}`;
  document.getElementById('connLabel').textContent = msg;
}


//  Main render


function render(data) {
  const gs  = data.global_stats;
  const adv = data.advanced;

  // ── Fix 6: Detect session change and reset all stale UI ──────
  if (data.session_id && data.session_id !== _currentSessionId) {
    _currentSessionId = data.session_id;
    resetSessionUI();
  }

  // Status bar
  document.getElementById('sessionTitle').textContent = `Active Session — Patient: ${data.patient_id}`;
  document.getElementById('sessionSub').textContent   = `${data.session_id}  ·  ${(data.timestamp||'').slice(0,19).replace('T',' ')} UTC`;
  document.getElementById('infoPatient').textContent  = data.patient_id;
  document.getElementById('infoSession').textContent  = data.session_id;

  // Metric cards with trend deltas
  setMetric('mFocus',    gs.focus_level.toFixed(3), 'bFocus',    gs.focus_level * 100,   'dFocus',    _prevFocus,    gs.focus_level,  true);
  setMetric('mStress',   gs.max_stress.toFixed(2),  'bStress',   gs.max_stress * 4,       'dStress',   _prevStress,   gs.max_stress,   false);
  setMetric('mAvgStress',gs.avg_stress.toFixed(2),  'bAvgStress',gs.avg_stress * 5,       'dAvgStress',_prevAvg,      gs.avg_stress,   false);
  setMetric('mTremor',   gs.max_tremor.toFixed(2),  'bTremor',   gs.max_tremor * 10,      'dTremor',   _prevTremor,   gs.max_tremor,   false);
  _prevFocus = gs.focus_level; _prevStress = gs.max_stress;
  _prevAvg   = gs.avg_stress;  _prevTremor = gs.max_tremor;

  document.getElementById('focusLast').textContent  = gs.focus_level.toFixed(3);
  document.getElementById('stressLast').textContent = gs.max_stress.toFixed(2);

  if (adv) renderAdvanced(adv, data);

  renderBodyMap(data.body_status);
  renderCurrentAI(data.ai_command);

  // Charts
  const now = Date.now();
  if (now - lastChart >= CHART_THR) {
    lastChart = now;
    pushPt(focusChart,  gs.focus_level);
    pushPt(stressChart, gs.max_stress);
    focusChart.update('none');
    stressChart.update('none');
  }
}

function setMetric(valId, val, barId, pct, deltaId, prev, cur, higherGood) {
  document.getElementById(valId).textContent = val;
  const bar = document.getElementById(barId);
  if (bar) bar.style.width = Math.min(100, Math.max(0, pct)) + '%';
  const del = document.getElementById(deltaId);
  if (del && prev !== null) {
    const diff = cur - prev;
    const rising = diff > 0.001;
    const falling = diff < -0.001;
    if (rising) {
      del.className = `metric-delta ${higherGood ? 'delta-dn' : 'delta-up'}`;
      del.textContent = '▲';
    } else if (falling) {
      del.className = `metric-delta ${higherGood ? 'delta-up' : 'delta-dn'}`;
      del.textContent = '▼';
    } else {
      del.className = 'metric-delta delta-stable';
      del.textContent = '—';
    }
  }
}


//  Advanced analytics panel

function renderAdvanced(adv, data) {
  const risk = adv.risk_classification || 'LOW';
  const stab = adv.stability_index ?? 0;
  const conf = adv.confidence_score ?? 0;

  // Risk badge
  for (const el of document.querySelectorAll('#riskBadge, #riskBadgeBig')) {
    el.className = `badge risk-${risk}`;
    el.textContent = `${risk} RISK`;
  }

  // Stability ring
  const circ = 2 * Math.PI * 46;
  const arc  = document.getElementById('stabArc');
  if (arc) {
    arc.style.strokeDashoffset = circ - (stab / 100) * circ;
    arc.style.stroke = stab >= 70 ? '#00F5FF' : stab >= 40 ? '#F59E0B' : '#DC2626';
  }
  const sv = document.getElementById('stabVal');
  if (sv) {
    sv.textContent = stab;
    sv.style.color = stab >= 70 ? '#00F5FF' : stab >= 40 ? '#F59E0B' : '#EF4444';
  }

  // Confidence
  document.getElementById('confPct').textContent    = (conf * 100).toFixed(0) + '%';
  document.getElementById('bigConfBar').style.width = (conf * 100) + '%';
  document.getElementById('mConf').textContent      = (conf * 100).toFixed(0) + '%';
  document.getElementById('bConf').style.width      = (conf * 100) + '%';
  const confLbl = conf < 0.3 ? 'Low — insufficient data' : conf < 0.6 ? 'Moderate' : 'High reliability';
  document.getElementById('mConfLabel').textContent  = confLbl;

  // Trend
  const trend = adv.trend_direction || 'stable';
  const tEl   = document.getElementById('trendLabel');
  if (tEl) {
    tEl.className = `text-xs font-semibold ${trend === 'rising' ? 't-up' : trend === 'falling' ? 't-dn' : 't-st'}`;
    tEl.textContent = trend === 'rising' ? '▲ Rising' : trend === 'falling' ? '▼ Falling' : '— Stable';
  }

  // Escalation dots
  const esc = adv.escalation_level ?? 0;
  const eEl = document.getElementById('escalDots');
  if (eEl) {
    eEl.innerHTML = [0,1,2].map(i =>
      `<div style="width:8px;height:8px;border-radius:50%;background:${i < esc ? '#dc2626' : 'rgba(255,255,255,.06)'}"></div>`
    ).join('');
  }

  // Session info
  const dur = adv.session_duration_s ?? 0;
  const mm  = Math.floor(dur/60).toString().padStart(2,'0');
  const ss  = Math.floor(dur%60).toString().padStart(2,'0');
  document.getElementById('infoDuration').textContent = `${mm}:${ss}`;
  document.getElementById('infoFrames').textContent   = (adv.frame_count ?? 0).toLocaleString() + ' frames';
  document.getElementById('durationLabel').textContent = `Duration: ${mm}:${ss}`;
  document.getElementById('frameLabel').textContent    = `${(adv.frame_count ?? 0).toLocaleString()} frames`;

  // Anomaly banner
  const ab = document.getElementById('anomalyBanner');
  if (adv.anomaly_count > 0) ab.classList.remove('hidden');
  else                        ab.classList.add('hidden');

  // Predictions
  renderPredictions(adv);

  // Clinical action
  document.getElementById('clinActionText').textContent = adv.clinical_action || '—';
  const cap = document.getElementById('clinActionPanel');
  const borderCol = risk === 'CRITICAL' ? 'rgba(220,38,38,.35)' : risk === 'HIGH' ? 'rgba(217,119,6,.3)' : 'rgba(59,130,246,.2)';
  cap.style.borderColor = borderCol;

  // Regions
  renderRegions(adv.top_affected_regions || []);

  // Anomalies
  renderAnomalies(adv.anomalies || []);

  // Summary
  if (adv.session_summary) {
    document.getElementById('sessionSummary').textContent = adv.session_summary;
    document.getElementById('summaryTs').textContent = new Date().toLocaleTimeString();
  }
}


//  Predictions panel

function renderPredictions(adv) {
  function fillPred(suffix, pred) {
    const valEl   = document.getElementById(`pred${suffix}`);
    const trendEl = document.getElementById(`pred${suffix}trend`);
    const barEl   = document.getElementById(`pred${suffix}bar`);
    if (!pred) {
      if (valEl) valEl.textContent = '—';
      return;
    }
    const v    = pred.avg_predicted_stress ?? 0;
    const tStr = pred.session_risk_trend   || 'stable';
    const colBase = v >= 15 ? '#ef4444' : v >= 10 ? '#fbbf24' : '#60a5fa';

    if (valEl)   { valEl.textContent = v.toFixed(1); valEl.style.color = colBase; }
    if (trendEl) {
      trendEl.className = `text-xs ${tStr === 'escalating' ? 't-up' : tStr === 'de-escalating' ? 't-dn' : 't-st'}`;
      trendEl.textContent = tStr;
    }
    if (barEl) barEl.style.width = Math.min(100, v * 4) + '%';
  }

  fillPred('30',  adv.prediction_30s);
  fillPred('60',  adv.prediction_60s);
  fillPred('120', adv.prediction_120s);

  const pw = document.getElementById('predWarning');
  const p120 = adv.prediction_120s;
  if (p120 && p120.sensors_at_risk && p120.sensors_at_risk.length > 0 && p120.confidence > 0.3) {
    pw.classList.remove('hidden');
    pw.textContent = `⚑ Forecast: ${p120.sensors_at_risk.length} sensor(s) projected to breach critical threshold within 120s (conf. ${(p120.confidence*100).toFixed(0)}%)`;
  } else {
    pw.classList.add('hidden');
  }
}


//  Body map — uses setAttribute for SVG className compat

const COLOR_MAP = {
  normal:   's-normal',
  mild:     's-mild',
  elevated: 's-elevated',
  warning:  's-warning',
  critical: 's-critical',
};

// Pre-cache all segment elements once
const _segCache = {};
function _getSeg(name) {
  if (!_segCache[name]) _segCache[name] = document.getElementById(`part-${name}`);
  return _segCache[name];
}

function renderBodyMap(bs) {
  if (!bs) return;
  for (const [name, d] of Object.entries(bs)) {
    const el = _getSeg(name);
    if (!el) continue;
    const cls = `seg ${COLOR_MAP[d.color] || 's-normal'}`;
    // SVG elements require setAttribute — plain .className is unreliable in SVG
    el.setAttribute('class', cls);
    const lbl = BODY_LABELS[name] || name;
    el.onmouseenter = () => {
      const zStr    = d.stress_z  !== undefined ? ` · z=${d.stress_z.toFixed(2)}σ` : '';
      const slopeStr = d.slope    !== undefined && Math.abs(d.slope) > 0.01
        ? ` · slope ${d.slope > 0 ? '▲' : '▼'}${Math.abs(d.slope).toFixed(2)}`
        : '';
      document.getElementById('bodyTip').textContent =
        `${lbl} · Arousal:${(d.stress_trend||0).toFixed(1)} · Tremor:${(d.tremor||0).toFixed(1)}${zStr}${slopeStr}`;
    };
    el.onmouseleave = () => { document.getElementById('bodyTip').textContent = ''; };
  }
}

// Reset all body map segments to normal
function resetBodyMap() {
  document.querySelectorAll('#mapSvg .seg').forEach(el => el.setAttribute('class', 'seg s-normal'));
}


//  Current AI Command (replaces the old scrolling log)

const SEV_BORDER = {
  critical: 'rgba(220,38,38,.45)',
  high:     'rgba(239,68,68,.3)',
  medium:   'rgba(139,92,246,.3)',
  moderate: 'rgba(139,92,246,.3)',
  low:      'rgba(255,255,255,.07)',
};

function renderCurrentAI(ai) {
  if (!ai) return;
  const card    = document.getElementById('aiCmdCard');
  const badge   = document.getElementById('aiCmdBadge');
  const name    = document.getElementById('aiCmdName');
  const reason  = document.getElementById('aiCmdReason');
  const ts      = document.getElementById('aiLastTs');

  const sev = (ai.severity || 'low').toLowerCase();
  badge.className = `badge ${SEV_CLS[sev] || 'b-low'}`;
  badge.textContent = sev;
  name.textContent  = (ai.command || '—').replace(/_/g, ' ');
  reason.textContent = ai.reason || '';
  if (card) card.style.borderColor = SEV_BORDER[sev] || 'var(--bdr)';
  if (ts && ai.timestamp) ts.textContent = ai.timestamp.slice(-8) || ''; // show HH:MM:SS
}


//  Session Reset — clears all stale data when session changes

function resetSessionUI() {
  // Prev-value deltas
  _prevFocus = null; _prevStress = null; _prevAvg = null; _prevTremor = null;

  // Metric cards
  ['mFocus','mStress','mAvgStress','mTremor','mConf'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = '—';
  });
  ['bFocus','bStress','bAvgStress','bTremor','bConf'].forEach(id => {
    const el = document.getElementById(id); if (el) el.style.width = '0%';
  });
  ['dFocus','dStress','dAvgStress','dTremor'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = 'metric-delta delta-stable'; el.textContent = '—'; }
  });

  // Status bar
  document.getElementById('durationLabel').textContent = '';
  document.getElementById('frameLabel').textContent    = '';
  document.getElementById('infoDuration').textContent  = '00:00';
  document.getElementById('infoFrames').textContent    = '0 frames';

  // Stability + risk
  const arc = document.getElementById('stabArc');
  if (arc) { arc.style.strokeDashoffset = '289'; arc.style.stroke = '#00F5FF'; }
  const sv  = document.getElementById('stabVal');
  if (sv)   { sv.textContent = '—'; sv.style.color = '#00F5FF'; }
  ['riskBadge','riskBadgeBig'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = 'badge risk-LOW'; el.textContent = 'LOW RISK'; }
  });

  // Confidence
  ['confPct','bigConfBar'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { if (el.tagName === 'SPAN' || el.tagName === 'DIV' && !el.style.width) el.textContent = '—'; else el.style.width = '0%'; }
  });
  document.getElementById('confPct').textContent     = '—';
  document.getElementById('bigConfBar').style.width  = '0%';
  document.getElementById('mConfLabel').textContent   = 'Awaiting data…';

  // Trend + escalation
  const te = document.getElementById('trendLabel');
  if (te) { te.className = 'text-xs font-semibold t-st'; te.textContent = '— Stable'; }
  const ee = document.getElementById('escalDots');
  if (ee) ee.innerHTML = [0,1,2].map(() =>
    `<div style="width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.06)"></div>`
  ).join('');

  // Predictions
  ['30','60','120'].forEach(s => {
    const v = document.getElementById(`pred${s}`);
    const t = document.getElementById(`pred${s}trend`);
    const b = document.getElementById(`pred${s}bar`);
    if (v) { v.textContent = '—'; v.style.color = 'var(--t3)'; }
    if (t) t.textContent = '—';
    if (b) b.style.width = '0%';
  });
  const pw = document.getElementById('predWarning');
  if (pw) pw.classList.add('hidden');

  // Body map → all normal
  resetBodyMap();

  // AI command card
  const aiName   = document.getElementById('aiCmdName');
  const aiReason = document.getElementById('aiCmdReason');
  const aiBadge  = document.getElementById('aiCmdBadge');
  const aiCard   = document.getElementById('aiCmdCard');
  if (aiName)   aiName.textContent   = 'New session starting…';
  if (aiReason) aiReason.textContent = '';
  if (aiBadge)  { aiBadge.className  = 'badge b-low'; aiBadge.textContent = 'low'; }
  if (aiCard)   aiCard.style.borderColor = 'var(--bdr)';
  document.getElementById('aiLastTs').textContent = '';

  // Anomalies + regions
  document.getElementById('anomList').innerHTML =
    '<div class="empty" style="padding:8px"><p>No anomalies detected</p></div>';
  document.getElementById('anomCount').textContent = '0 detected';
  document.getElementById('regionList').innerHTML =
    '<div class="empty" style="padding:8px"><p>Awaiting session data</p></div>';

  // Session summary
  document.getElementById('sessionSummary').textContent = 'Session just started — summary will appear once data is collected.';

  // Charts — clear all data points
  if (focusChart)  { focusChart.data.labels = [];  focusChart.data.datasets[0].data = [];  focusChart.update('none'); }
  if (stressChart) { stressChart.data.labels = []; stressChart.data.datasets[0].data = []; stressChart.update('none'); }

  // Anomaly banner
  const ab = document.getElementById('anomalyBanner');
  if (ab) ab.classList.add('hidden');
}


//  Anomaly list

function renderAnomalies(anomalies) {
  const cnt = document.getElementById('anomCount');
  const lst = document.getElementById('anomList');
  cnt.textContent = `${anomalies.length} detected`;
  if (!anomalies.length) {
    lst.innerHTML = '<div class="empty" style="padding:8px"><p>No anomalies detected</p></div>';
    return;
  }
  lst.innerHTML = anomalies.map(a => `
    <div class="anomaly-row">
      <div class="flex justify-between items-start">
        <div class="text-xs font-medium" style="color:var(--text)">${a.sensor?.replace(/_/g,' ')||'—'}</div>
        <span class="badge ${SEV_CLS[a.severity]||'b-low'}">${a.severity||'—'} · ${a.method||'—'}</span>
      </div>
      <div class="text-xs mt-0.5 leading-snug" style="color:var(--t3)">${a.description||''}</div>
      <div class="mono mt-0.5 flex gap-3" style="font-size:9px;color:var(--t3)">
        <span>z=${a.score?.toFixed(2)||'—'}</span>
        <span>conf=${((a.confidence||0)*100).toFixed(0)}%</span>
        <span>val=${a.value?.toFixed(2)||'—'}</span>
        <span>baseline=${a.baseline?.toFixed(2)||'—'}</span>
      </div>
    </div>`).join('');
}


//  Top regions

function renderRegions(regions) {
  const el = document.getElementById('regionList');
  if (!regions.length) {
    el.innerHTML = '<div class="empty" style="padding:8px"><p>No session active</p></div>';
    return;
  }
  const maxScore = regions[0].score || 1;
  el.innerHTML = regions.map((r, i) => {
    const pct  = maxScore > 0 ? ((r.score / maxScore) * 100) : 0;
    const col  = r.score > 55 ? '#EF4444' : r.score > 30 ? '#F59E0B' : '#00F5FF';
    const sArrow = r.slope > 0.5 ? '<span class="t-up">▲</span>' : r.slope < -0.5 ? '<span class="t-dn">▼</span>' : '';
    return `<div>
      <div class="flex justify-between items-center">
        <div class="text-xs font-medium" style="color:var(--t2)">${i+1}. ${r.name}</div>
        <div class="flex items-center gap-1">
          ${sArrow}
          <span class="mono text-xs font-bold" style="color:${col}">${r.score.toFixed(1)}</span>
        </div>
      </div>
      <div class="region-bar"><div class="region-fill" style="width:${pct.toFixed(0)}%;background:${col}"></div></div>
      <div class="mono flex gap-3 mt-0.5" style="font-size:9px;color:var(--t3)">
        <span>σ=${r.std?.toFixed(2)||'—'}</span>
        <span>peak=${r.peak_stress?.toFixed(1)||'—'}</span>
        <span>ema=${r.ema_stress?.toFixed(1)||'—'}</span>
      </div>
    </div>`;
  }).join('');
}


//  Tabs

function showTab(name) {
  ['monitor','compare','patients','history'].forEach(t => {
    document.getElementById(`content-${t}`)?.classList.add('hidden');
    document.getElementById(`tab-${t}`)?.classList.remove('tab-active');
  });
  document.getElementById(`content-${name}`)?.classList.remove('hidden');
  document.getElementById(`tab-${name}`)?.classList.add('tab-active');
  if (name === 'patients') loadPatients();
}


//  Historical Comparison

let cmpFocChart = null, cmpStrChart = null;

async function runComparison() {
  const sidA = document.getElementById('cmpSidA').value.trim();
  const pidA = document.getElementById('cmpPidA').value.trim();
  const sidB = document.getElementById('cmpSidB').value.trim();
  const pidB = document.getElementById('cmpPidB').value.trim();

  if ((!sidA && !pidA) || (!sidB && !pidB)) {
    document.getElementById('cmpStatus').textContent = 'Please supply at least one identifier for each session.';
    return;
  }

  document.getElementById('cmpStatus').textContent = 'Loading sessions…';

  async function fetchExport(sid, pid) {
    const p = new URLSearchParams();
    if (sid) p.set('session_id', sid);
    if (pid) p.set('patient_id', pid);
    const r = await fetch(`/api/session/export?${p}`, { headers: AUTH });
    if (!r.ok) return null;
    return r.json();
  }

  try {
    const [dataA, dataB] = await Promise.all([
      fetchExport(sidA, pidA),
      fetchExport(sidB, pidB),
    ]);

    if (!dataA?.summary || !dataB?.summary) {
      document.getElementById('cmpStatus').textContent =
        'No records found for one or both sessions. Check identifiers and try again.';
      return;
    }

    document.getElementById('cmpStatus').textContent =
      `Loaded: Session A (${dataA.summary.total_records} records) · Session B (${dataB.summary.total_records} records)`;

    // Summary cards
    const sa = dataA.summary, sb = dataB.summary;
    document.getElementById('cmpFocA').textContent  = sa.avg_focus   + '%';
    document.getElementById('cmpFocB').textContent  = sb.avg_focus   + '%';
    document.getElementById('cmpStrA').textContent  = sa.peak_stress + '%';
    document.getElementById('cmpStrB').textContent  = sb.peak_stress + '%';
    document.getElementById('cmpTrA').textContent   = sa.avg_tremor.toFixed(2);
    document.getElementById('cmpTrB').textContent   = sb.avg_tremor.toFixed(2);
    document.getElementById('cmpCritA').textContent = sa.critical_events;
    document.getElementById('cmpCritB').textContent = sb.critical_events;
    document.getElementById('cmpCards').classList.remove('hidden');
    document.getElementById('cmpCharts').classList.remove('hidden');
    document.getElementById('cmpDelta').classList.remove('hidden');

    // Overlay charts
    buildCmpChart(dataA.rows, dataB.rows);

    // Delta narrative
    buildDeltaNarrative(sa, sb);

  } catch (e) {
    document.getElementById('cmpStatus').textContent = 'Error loading data: ' + e.message;
  }
}

function buildCmpChart(rowsA, rowsB) {
  // Downsample to max 80 pts each
  function sample(rows, key, max) {
    const step = Math.max(1, Math.floor(rows.length / max));
    return rows.filter((_, i) => i % step === 0).map(r => r[key]);
  }
  function labels(rows, max) {
    const step = Math.max(1, Math.floor(rows.length / max));
    return rows.filter((_, i) => i % step === 0).map(r => (r.ts || '').slice(11, 19));
  }

  const MAX = 80;
  const labA = labels(rowsA, MAX), labB = labels(rowsB, MAX);
  const focA = sample(rowsA, 'f', MAX).map(v => (v || 0) / 100);
  const focB = sample(rowsB, 'f', MAX).map(v => (v || 0) / 100);
  const strA = sample(rowsA, 's', MAX).map(v => (v || 0) / 5);
  const strB = sample(rowsB, 's', MAX).map(v => (v || 0) / 5);
  const maxLen = Math.max(labA.length, labB.length);
  const xlabels = Array.from({ length: maxLen }, (_, i) => i.toString());

  function makeCmpChart(id, dsA, dsB, colA, colB, yMin, yMax, thresholds) {
    const ctx = document.getElementById(id).getContext('2d');
    if (id === 'cmpFocusChart'  && cmpFocChart) { cmpFocChart.destroy(); cmpFocChart = null; }
    if (id === 'cmpStressChart' && cmpStrChart) { cmpStrChart.destroy(); cmpStrChart = null; }

    const annotations = {};
    (thresholds || []).forEach((th, i) => {
      annotations[`t${i}`] = {
        type: 'line', yMin: th.val, yMax: th.val,
        borderColor: th.color, borderWidth: 1, borderDash: [5, 4],
        label: { display: true, content: th.label, position: 'end',
                 backgroundColor: 'transparent', color: th.color,
                 font: { size: 9, weight: '600' }, padding: { x: 4, y: 2 } }
      };
    });

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: xlabels,
        datasets: [
          { label: 'Session A', data: dsA, borderColor: colA, backgroundColor: colA + '18',
            borderWidth: 1.6, fill: true, tension: 0.35, pointRadius: 0 },
          { label: 'Session B', data: dsB, borderColor: colB, backgroundColor: colB + '18',
            borderWidth: 1.6, fill: true, tension: 0.35, pointRadius: 0,
            borderDash: [4, 3] },
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: {
          legend: { display: false },
          annotation: { annotations },
          tooltip: {
            backgroundColor: 'rgba(20,25,34,.97)',
            titleColor: '#94A3B8', bodyColor: '#E6EDF7',
            borderColor: 'rgba(59,130,246,.25)', borderWidth: 1,
          }
        },
        scales: {
          y: { min: yMin, max: yMax,
               grid: { color: 'rgba(255,255,255,.04)' },
               ticks: { color: '#4A5568', font: { size: 9 }, maxTicksLimit: 6 },
               border: { color: 'rgba(255,255,255,.05)' } },
          x: { grid: { display: false },
               ticks: { color: '#4A5568', font: { size: 9 }, maxTicksLimit: 10, maxRotation: 0 },
               border: { color: 'rgba(255,255,255,.05)' } }
        }
      }
    });
    if (id === 'cmpFocusChart')  cmpFocChart = chart;
    if (id === 'cmpStressChart') cmpStrChart = chart;
  }

  makeCmpChart('cmpFocusChart',  focA, focB, '#00F5FF', '#8B5CF6', 0, 1, [
    { val: 0.6,  label: 'Alert',    color: 'rgba(217,119,6,.5)' },
    { val: 0.35, label: 'Critical', color: 'rgba(220,38,38,.5)' },
  ]);
  makeCmpChart('cmpStressChart', strA, strB, '#EF4444', '#8B5CF6', 0, 25, [
    { val: 10, label: 'Alert',    color: 'rgba(217,119,6,.5)' },
    { val: 15, label: 'Critical', color: 'rgba(220,38,38,.5)' },
  ]);
}

function buildDeltaNarrative(sa, sb) {
  const deltaFocus  = sb.avg_focus   - sa.avg_focus;
  const deltaPeak   = sb.peak_stress - sa.peak_stress;
  const deltaTremor = sb.avg_tremor  - sa.avg_tremor;
  const deltaCrit   = sb.critical_events - sa.critical_events;

  function deltaEl(val, higherGood, label, unit) {
    const good  = higherGood ? val > 0 : val < 0;
    const color = Math.abs(val) < 1 ? 'var(--t3)' : good ? '#4ade80' : '#f87171';
    const arrow = val > 0.5 ? '▲' : val < -0.5 ? '▼' : '—';
    return `<div>
      <div class="section-label" style="margin-bottom:3px">${label}</div>
      <div class="text-lg font-bold mono" style="color:${color}">${arrow} ${val >= 0 ? '+' : ''}${(typeof val === 'number' ? val.toFixed(2) : val)}${unit}</div>
      <div class="text-xs" style="color:var(--t3)">${good ? 'Improvement' : Math.abs(val) < 1 ? 'Negligible change' : 'Regression'}</div>
    </div>`;
  }

  document.getElementById('cmpDeltaBody').innerHTML =
    deltaEl(deltaFocus,  true,  'Focus Index Change',     '%') +
    deltaEl(deltaPeak,   false, 'Peak Arousal Change',    '%') +
    deltaEl(deltaCrit,   false, 'Critical Events Change', '');

  // Narrative
  const improvements = [], regressions = [];
  if (deltaFocus  > 2)  improvements.push(`improved focus index (+${deltaFocus.toFixed(1)}%)`);
  if (deltaFocus  < -2) regressions.push(`decreased focus index (${deltaFocus.toFixed(1)}%)`);
  if (deltaPeak   < -3) improvements.push(`lower peak arousal (${deltaPeak.toFixed(1)}%)`);
  if (deltaPeak   > 3)  regressions.push(`higher peak arousal (+${deltaPeak.toFixed(1)}%)`);
  if (deltaCrit   < 0)  improvements.push(`fewer critical events (${deltaCrit})`);
  if (deltaCrit   > 0)  regressions.push(`more critical events (+${deltaCrit})`);
  if (deltaTremor < -0.5) improvements.push(`reduced tremor (${deltaTremor.toFixed(2)})`);
  if (deltaTremor > 0.5)  regressions.push(`increased tremor (+${deltaTremor.toFixed(2)})`);

  let narrative = 'Clinical comparison — Session B vs Session A: ';
  if (!improvements.length && !regressions.length) {
    narrative += 'No clinically significant differences detected between sessions.';
  } else {
    if (improvements.length) narrative += `Improvements observed in ${improvements.join(', ')}. `;
    if (regressions.length)  narrative += `Regressions observed in ${regressions.join(', ')}. `;
    narrative += 'Interpret findings in the context of session duration, patient state, and therapeutic goals.';
  }
  document.getElementById('cmpNarrative').textContent = narrative;
}

function clearComparison() {
  ['cmpSidA','cmpPidA','cmpSidB','cmpPidB'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('cmpStatus').textContent = '';
  document.getElementById('cmpCards').classList.add('hidden');
  document.getElementById('cmpCharts').classList.add('hidden');
  document.getElementById('cmpDelta').classList.add('hidden');
  if (cmpFocChart) { cmpFocChart.destroy(); cmpFocChart = null; }
  if (cmpStrChart) { cmpStrChart.destroy(); cmpStrChart = null; }
}


//  Patients CRUD

async function loadPatients() {
  const r = await fetch('/api/patients', { headers: AUTH });
  if (r.status === 401) { logout(); return; }
  const data = await r.json();
  const lvlCls = { 'Level 1':'b-low', 'Level 2':'b-moderate', 'Level 3':'b-critical' };
  document.getElementById('ptBody').innerHTML = data.length
    ? data.map(p => `<tr>
        <td class="mono" style="color:var(--t3)">${p.id}</td>
        <td class="font-medium">${p.name}</td>
        <td>${p.age}</td><td>${p.gender}</td>
        <td><span class="badge ${lvlCls[p.diagnosis_level]||'b-low'}">${p.diagnosis_level}</span></td>
        <td style="color:var(--t3);max-width:130px" class="truncate">${p.notes||'—'}</td>
        <td class="mono" style="color:var(--t3)">${p.created_at?.slice(0,10)||'—'}</td>
        <td class="flex gap-2">
          <button onclick="editPt(${p.id})" class="btn-secondary" style="padding:2px 8px">Edit</button>
          <button onclick="delPt(${p.id})" class="btn-danger" style="padding:2px 8px">Delete</button>
        </td>
      </tr>`).join('')
    : `<tr><td colspan="8"><div class="empty"><p>No patients registered</p></div></td></tr>`;
}

function showAddPt() {
  document.getElementById('ptModalTitle').textContent = 'Register New Patient';
  document.getElementById('ptForm').reset();
  document.getElementById('ptId').value = '';
  document.getElementById('ptModal').classList.remove('hidden');
}
function hidePtModal() { document.getElementById('ptModal').classList.add('hidden'); }

async function editPt(id) {
  const r = await fetch('/api/patients', { headers: AUTH });
  const list = await r.json();
  const p = list.find(x => x.id === id);
  if (!p) return;
  document.getElementById('ptModalTitle').textContent = 'Edit Patient Record';
  document.getElementById('ptId').value     = p.id;
  document.getElementById('ptName').value   = p.name;
  document.getElementById('ptAge').value    = p.age;
  document.getElementById('ptGender').value = p.gender;
  document.getElementById('ptLevel').value  = p.diagnosis_level;
  document.getElementById('ptNotes').value  = p.notes || '';
  document.getElementById('ptModal').classList.remove('hidden');
}

async function delPt(id) {
  if (!confirm('Delete this patient record? This action cannot be undone.')) return;
  await fetch(`/api/patients/${id}`, { method:'DELETE', headers: AUTH });
  loadPatients();
}

document.getElementById('ptForm').addEventListener('submit', async e => {
  e.preventDefault();
  const pid  = document.getElementById('ptId').value;
  const body = {
    name:            document.getElementById('ptName').value,
    age:             parseInt(document.getElementById('ptAge').value, 10),
    gender:          document.getElementById('ptGender').value,
    diagnosis_level: document.getElementById('ptLevel').value,
    notes:           document.getElementById('ptNotes').value,
  };
  const url    = pid ? `/api/patients/${pid}` : '/api/patients';
  const method = pid ? 'PUT' : 'POST';
  const r = await fetch(url, { method, headers: { ...AUTH, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if (r.status === 401) { logout(); return; }
  hidePtModal();
  loadPatients();
});


//  History

async function loadHistory() {
  const p = new URLSearchParams({ limit: 200 });
  const sid  = document.getElementById('hSID').value.trim();
  const pid  = document.getElementById('hPID').value.trim();
  const from = document.getElementById('hFrom').value;
  const to   = document.getElementById('hTo').value;
  if (sid)  p.set('session_id', sid);
  if (pid)  p.set('patient_id', pid);
  if (from) p.set('date_from',  from);
  if (to)   p.set('date_to',    to);

  const tbody = document.getElementById('hBody');
  tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><p>Loading…</p></div></td></tr>`;
  const r = await fetch(`/api/session/history?${p}`, { headers: AUTH });
  if (r.status === 401) { logout(); return; }
  const data = await r.json();
  document.getElementById('hCount').textContent = data.length ? `${data.length} records found` : '';
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><p>No records for these filters</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(row => {
    const ts = (row.recorded_at||'').slice(0,19).replace('T',' ');
    const fc = row.focus_level >= 70 ? '#4ade80' : row.focus_level >= 40 ? '#fbbf24' : '#ef4444';
    const sc = row.stress_level <= 30 ? '#4ade80' : row.stress_level <= 60 ? '#fbbf24' : '#ef4444';
    const sev = row.ai_severity || 'low';
    return `<tr>
      <td class="mono" style="color:var(--t3)">${ts}</td>
      <td class="mono" style="color:var(--t2);max-width:90px;overflow:hidden;text-overflow:ellipsis" title="${row.session_id}">${row.session_id}</td>
      <td>${row.patient_id}</td>
      <td class="mono font-bold" style="color:${fc}">${row.focus_level}%</td>
      <td class="mono font-bold" style="color:${sc}">${row.stress_level}%</td>
      <td class="mono" style="color:var(--t3)">${row.max_tremor?.toFixed(1)||'—'}</td>
      <td class="capitalize">${(row.ai_command||'—').replace(/_/g,' ')}</td>
      <td><span class="badge ${SEV_CLS[sev]||'b-low'}">${sev}</span></td>
    </tr>`;
  }).join('');
}

function clearHist() {
  ['hSID','hPID','hFrom','hTo'].forEach(id => document.getElementById(id).value='');
  document.getElementById('hBody').innerHTML =
    `<tr><td colspan="8"><div class="empty"><p>Run a query to load history</p></div></td></tr>`;
  document.getElementById('hCount').textContent='';
}


//  PDF Export

function exportPDF() {
  // Populate print header fields
  const now = new Date();
  document.getElementById('printDate').textContent  = now.toLocaleString();
  document.getElementById('printDoc').textContent   = document.getElementById('doctorName').textContent || 'Clinician';
  const sid   = document.getElementById('infoSession').textContent || '';
  const pid   = document.getElementById('infoPatient').textContent || '';
  const dur   = document.getElementById('infoDuration').textContent || '';
  document.getElementById('printMeta').textContent  = `Session: ${sid} · Patient: ${pid} · Duration: ${dur}`;

  // Show monitor tab for print
  showTab('monitor');
  setTimeout(() => window.print(), 250);
}


//  Auth / Init

function logout() { localStorage.removeItem('jwt_token'); location.href = '/login'; }

async function loadDoctorInfo() {
  try {
    const r = await fetch('/api/me', { headers: AUTH });
    if (r.ok) {
      const d = await r.json();
      document.getElementById('doctorName').textContent = d.full_name || d.username;
      document.getElementById('doctorRole').textContent = 'Clinical Therapist';
      document.getElementById('printDoc').textContent   = d.full_name || d.username;
    }
  } catch {}
}

document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  connectWS();
  loadDoctorInfo();
  fetchLatestFrame();  // immediate data on page load, no waiting for WS
});

// ════════════════════════════════════════════════════════
//  Initial data fetch — pull latest frame via REST so the
//  page shows real data immediately on load/refresh,
//  without waiting for the next WS broadcast.
// ════════════════════════════════════════════════════════
async function fetchLatestFrame() {
  try {
    const r = await fetch('/api/session/latest', { headers: AUTH });
    if (r.ok) {
      const data = await r.json();
      if (data && data.global_stats) render(data);
    }
  } catch {}
  // Poll every 2s as fallback when WS hasn't delivered yet
  // Stops automatically once WS is live (WS sets _wsLive = true)
  if (!_wsLive) setTimeout(fetchLatestFrame, 2000);
}
let _wsLive = false;
</script>
</body>
</html>
